<!--
  SOC-in-a-Box Sysmon Configuration
  Based on SwiftOnSecurity sysmon-config
  Optimized for threat detection and MITRE ATT&CK coverage
  
  Installation:
  sysmon64.exe -accepteula -i sysmonconfig.xml
  
  Update:
  sysmon64.exe -c sysmonconfig.xml
-->

<Sysmon schemaversion="4.82">
  <HashAlgorithms>md5,sha256,IMPHASH</HashAlgorithms>
  <CheckRevocation>False</CheckRevocation>
  
  <EventFiltering>
    
    <!-- Event ID 1: Process Creation -->
    <ProcessCreate onmatch="include">
      <!-- Suspicious Processes -->
      <Image condition="contains">powershell</Image>
      <Image condition="contains">cmd.exe</Image>
      <Image condition="contains">wscript</Image>
      <Image condition="contains">cscript</Image>
      <Image condition="contains">mshta</Image>
      <Image condition="contains">regsvr32</Image>
      <Image condition="contains">rundll32</Image>
      <Image condition="contains">certutil</Image>
      <Image condition="contains">bitsadmin</Image>
      <Image condition="contains">msiexec</Image>
      <Image condition="contains">psexec</Image>
      <Image condition="contains">whoami</Image>
      <Image condition="contains">systeminfo</Image>
      <Image condition="contains">schtasks</Image>
      <Image condition="contains">sc.exe</Image>
      <Image condition="contains">net.exe</Image>
      <Image condition="contains">nltest</Image>
      <CommandLine condition="contains">-enc</CommandLine>
      <CommandLine condition="contains">bypass</CommandLine>
      <CommandLine condition="contains">hidden</CommandLine>
      <CommandLine condition="contains">downloadstring</CommandLine>
      <CommandLine condition="contains">invoke-expression</CommandLine>
      <CommandLine condition="contains">IEX</CommandLine>
    </ProcessCreate>

    <!-- Event ID 3: Network Connection -->
    <NetworkConnect onmatch="include">
      <Image condition="contains">powershell</Image>
      <Image condition="contains">cmd.exe</Image>
      <Image condition="contains">certutil</Image>
      <Image condition="contains">bitsadmin</Image>
      <DestinationPort condition="is">4444</DestinationPort>
      <DestinationPort condition="is">5555</DestinationPort>
      <DestinationPort condition="is">8080</DestinationPort>
      <DestinationPort condition="is">8443</DestinationPort>
    </NetworkConnect>

    <!-- Event ID 7: Image Loaded (DLL) -->
    <ImageLoad onmatch="include">
      <ImageLoaded condition="contains">clr.dll</ImageLoaded>
      <ImageLoaded condition="contains">mscoree.dll</ImageLoaded>
      <ImageLoaded condition="contains">amsi.dll</ImageLoaded>
    </ImageLoad>

    <!-- Event ID 8: CreateRemoteThread -->
    <CreateRemoteThread onmatch="include">
      <TargetImage condition="contains">lsass.exe</TargetImage>
    </CreateRemoteThread>

    <!-- Event ID 10: Process Access -->
    <ProcessAccess onmatch="include">
      <TargetImage condition="contains">lsass.exe</TargetImage>
    </ProcessAccess>

    <!-- Event ID 11: File Create -->
    <FileCreate onmatch="include">
      <TargetFilename condition="contains">\Startup\</TargetFilename>
      <TargetFilename condition="contains">\Start Menu\</TargetFilename>
      <TargetFilename condition="end with">.exe</TargetFilename>
      <TargetFilename condition="end with">.dll</TargetFilename>
      <TargetFilename condition="end with">.ps1</TargetFilename>
      <TargetFilename condition="end with">.bat</TargetFilename>
      <TargetFilename condition="end with">.vbs</TargetFilename>
    </FileCreate>

    <!-- Event ID 12, 13, 14: Registry Events -->
    <RegistryEvent onmatch="include">
      <TargetObject condition="contains">CurrentVersion\Run</TargetObject>
      <TargetObject condition="contains">CurrentVersion\RunOnce</TargetObject>
      <TargetObject condition="contains">CurrentVersion\RunServices</TargetObject>
      <TargetObject condition="contains">Policies\Explorer\Run</TargetObject>
      <TargetObject condition="contains">Group Policy\Scripts</TargetObject>
      <TargetObject condition="contains">Windows\CurrentVersion\Explorer\Shell Folders</TargetObject>
      <TargetObject condition="contains">Windows\CurrentVersion\Explorer\User Shell Folders</TargetObject>
      <TargetObject condition="contains">ControlSet\Services</TargetObject>
    </RegistryEvent>

    <!-- Event ID 15: FileCreateStreamHash (ADS) -->
    <FileCreateStreamHash onmatch="include">
      <TargetFilename condition="end with">.exe</TargetFilename>
      <TargetFilename condition="end with">.dll</TargetFilename>
    </FileCreateStreamHash>

    <!-- Event ID 22: DNS Query -->
    <DnsQuery onmatch="include">
      <QueryName condition="end with">.onion</QueryName>
      <QueryName condition="end with">.bit</QueryName>
      <QueryName condition="contains">pastebin</QueryName>
      <QueryName condition="contains">raw.githubusercontent</QueryName>
    </DnsQuery>

  </EventFiltering>
</Sysmon>
